/* Main.c file generated by New Project wizard
 *
 * Created:   do. oct. 18 2020
 * Processor: PIC18F45K22
 * Compiler:  MPLAB XC8
 */

#include <xc.h>

void initializate_variables() {
   TRISD = 0; // Set port D as output
   TRISA = 0; // Set port A as output
   TRISC = 1; // Set port C as input
   ANSELD = 0; // Set port D as digital
   ANSELA = 0; // Set port A as digital
   ANSELC = 0; // Set port C as digital
   PORTC = 0x00; // Initialize port C as 0x00
   PORTA = 0x00; // Initialize port A as 0x00
   PORTD = 0x00; // Initialize port D as 0x00
}

void print_n(int n) {
   if (n == 0) PORTD = 0x3F;
   else if (n == 1)  PORTD = 0x06;
   else if (n == 2) PORTD = 0x5B;
   else if (n == 3) PORTD = 0x4F;
   else if (n == 4)  PORTD = 0x66;
   else if (n == 5) PORTD = 0x6D;
   else if (n == 6) PORTD = 0x7D;
   else if (n == 7)  PORTD = 0x07;
   else if (n == 8) PORTD = 0x7F;
   else if (n == 9) PORTD = 0x6F;
}

void programa_1(int* n, int* c) {
   if (*c == 10000) {
      print_n(*n);
      ++(*n);
      if (*n == 10) *n = 0;
      *c = 0;
   }
   else ++(*c);
}

void programa_2(int n, int d, int* i) {
   if (*i == 0) {
      PORTD = 0x00;
      PORTA = 0x01;
      print_n(n % 10);

   }
   else if (*i == 1) {
      PORTD = 0x00;
      PORTA = 0x02;
      print_n((n % 100) / 10);
      if (d == 1) PORTD += 0x80;

   }
   else if (*i == 2) {
      PORTD = 0x00;
      PORTA = 0x04;
      print_n((n % 1000) / 100);
      if (d == 2) PORTD += 0x80;

   }
   else if (*i == 3) {
      PORTD = 0x00;
      PORTA = 0x08;
      print_n(n / 1000);
      if (d == 3) PORTD += 0x80; 

   }
   ++(*i);
   if (*i == 4) *i = 0;
}

void main(void) {
    initializate_variables();
   
    char programa = '1'; // Variable que determina quin programa s'ha d'executar, inicialitzat amb el programa 1
    PORTA = 0x02;
   
    char signal = 'L'; // Variable que serveix per controlar el flanc de pujada
    
    // Variables programa 1
    int c = 10000;
    int* c_ptr = &c;
    int n = 0;
    int* n_ptr = &n;
   
    // Variables programa 2
    int i = 0;
    int* i_ptr = &i;
   
    while (1) {
       
      // Flanc de pujada
      if (PORTCbits.RC1 == 1 && signal == 'L') {
	 signal = 'H';
	 if (programa == '1') { // Switch programa 1 -> programa 2
	    PORTD = 0x00;
	    programa = '2';
	 }
	 else { // Switch programa 2 -> programa 1
	    c = 10000;
	    n = 0;
	    PORTA = 0x02;
	    PORTD = 0x00;
	    programa = '1';
	 }
      }
      else if (PORTCbits.RC1 == 0 && signal == 'H') {
	 signal = 'L';
      }
      
      if (programa == '1') {
	 programa_1(n_ptr, c_ptr);
      }
      else {
	 programa_2(1111, 2, i_ptr);
      }
   }
}
 